!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.awaitility=e():t.awaitility=e()}(self,()=>(()=>{"use strict";var t={7:t=>{var e,r="object"==typeof Reflect?Reflect:null,n=r&&"function"==typeof r.apply?r.apply:function(t,e,r){return Function.prototype.apply.call(t,e,r)};e=r&&"function"==typeof r.ownKeys?r.ownKeys:Object.getOwnPropertySymbols?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.getOwnPropertyNames(t)};var o=Number.isNaN||function(t){return t!=t};function i(){i.init.call(this)}t.exports=i,t.exports.once=function(t,e){return new Promise(function(r,n){function o(r){t.removeListener(e,i),n(r)}function i(){"function"==typeof t.removeListener&&t.removeListener("error",o),r([].slice.call(arguments))}p(t,e,i,{once:!0}),"error"!==e&&function(t,e){"function"==typeof t.on&&p(t,"error",e,{once:!0})}(t,o)})},i.EventEmitter=i,i.prototype._events=void 0,i.prototype._eventsCount=0,i.prototype._maxListeners=void 0;var s=10;function a(t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}function c(t){return void 0===t._maxListeners?i.defaultMaxListeners:t._maxListeners}function h(t,e,r,n){var o,i,s,h;if(a(r),void 0===(i=t._events)?(i=t._events=Object.create(null),t._eventsCount=0):(void 0!==i.newListener&&(t.emit("newListener",e,r.listener?r.listener:r),i=t._events),s=i[e]),void 0===s)s=i[e]=r,++t._eventsCount;else if("function"==typeof s?s=i[e]=n?[r,s]:[s,r]:n?s.unshift(r):s.push(r),(o=c(t))>0&&s.length>o&&!s.warned){s.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=t,u.type=e,u.count=s.length,h=u,console&&console.warn&&console.warn(h)}return t}function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function f(t,e,r){var n={fired:!1,wrapFn:void 0,target:t,type:e,listener:r},o=u.bind(n);return o.listener=r,n.wrapFn=o,o}function l(t,e,r){var n=t._events;if(void 0===n)return[];var o=n[e];return void 0===o?[]:"function"==typeof o?r?[o.listener||o]:[o]:r?function(t){for(var e=new Array(t.length),r=0;r<e.length;++r)e[r]=t[r].listener||t[r];return e}(o):y(o,o.length)}function d(t){var e=this._events;if(void 0!==e){var r=e[t];if("function"==typeof r)return 1;if(void 0!==r)return r.length}return 0}function y(t,e){for(var r=new Array(e),n=0;n<e;++n)r[n]=t[n];return r}function p(t,e,r,n){if("function"==typeof t.on)n.once?t.once(e,r):t.on(e,r);else{if("function"!=typeof t.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t);t.addEventListener(e,function o(i){n.once&&t.removeEventListener(e,o),r(i)})}}Object.defineProperty(i,"defaultMaxListeners",{enumerable:!0,get:function(){return s},set:function(t){if("number"!=typeof t||t<0||o(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");s=t}}),i.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},i.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||o(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},i.prototype.getMaxListeners=function(){return c(this)},i.prototype.emit=function(t){for(var e=[],r=1;r<arguments.length;r++)e.push(arguments[r]);var o="error"===t,i=this._events;if(void 0!==i)o=o&&void 0===i.error;else if(!o)return!1;if(o){var s;if(e.length>0&&(s=e[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var c=i[t];if(void 0===c)return!1;if("function"==typeof c)n(c,this,e);else{var h=c.length,u=y(c,h);for(r=0;r<h;++r)n(u[r],this,e)}return!0},i.prototype.addListener=function(t,e){return h(this,t,e,!1)},i.prototype.on=i.prototype.addListener,i.prototype.prependListener=function(t,e){return h(this,t,e,!0)},i.prototype.once=function(t,e){return a(e),this.on(t,f(this,t,e)),this},i.prototype.prependOnceListener=function(t,e){return a(e),this.prependListener(t,f(this,t,e)),this},i.prototype.removeListener=function(t,e){var r,n,o,i,s;if(a(e),void 0===(n=this._events))return this;if(void 0===(r=n[t]))return this;if(r===e||r.listener===e)0===--this._eventsCount?this._events=Object.create(null):(delete n[t],n.removeListener&&this.emit("removeListener",t,r.listener||e));else if("function"!=typeof r){for(o=-1,i=r.length-1;i>=0;i--)if(r[i]===e||r[i].listener===e){s=r[i].listener,o=i;break}if(o<0)return this;0===o?r.shift():function(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}(r,o),1===r.length&&(n[t]=r[0]),void 0!==n.removeListener&&this.emit("removeListener",t,s||e)}return this},i.prototype.off=i.prototype.removeListener,i.prototype.removeAllListeners=function(t){var e,r,n;if(void 0===(r=this._events))return this;if(void 0===r.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==r[t]&&(0===--this._eventsCount?this._events=Object.create(null):delete r[t]),this;if(0===arguments.length){var o,i=Object.keys(r);for(n=0;n<i.length;++n)"removeListener"!==(o=i[n])&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(e=r[t]))this.removeListener(t,e);else if(void 0!==e)for(n=e.length-1;n>=0;n--)this.removeListener(t,e[n]);return this},i.prototype.listeners=function(t){return l(this,t,!0)},i.prototype.rawListeners=function(t){return l(this,t,!1)},i.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):d.call(t,e)},i.prototype.listenerCount=d,i.prototype.eventNames=function(){return this._eventsCount>0?e(this._events):[]}}},e={};function r(n){var o=e[n];if(void 0!==o)return o.exports;var i=e[n]={exports:{}};return t[n](i,i.exports,r),i.exports}r.d=(t,e)=>{for(var n in e)r.o(e,n)&&!r.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var n={};r.r(n),r.d(n,{Async:()=>w,DomHandler:()=>m,Handler:()=>d,HttpRequestHandler:()=>p,Notification:()=>y,Path:()=>a,Req:()=>s,Res:()=>i});var o=r(7);class i{static json(t,e,r,n,o="response"){t.statusCode=e,t.setHeader("Content-Type","application/json"),t.end(JSON.stringify(r)),n?.emit&&n.emit(o,{res:t,code:e,body:r})}static redirect(t,e){t.headersSent||t.writableEnded||(t.statusCode=302,t.setHeader("Location",e),t.end())}static end(t,e,r){return t.statusCode=e,t.end(r)}}class s{static async prepareBody(t,e){if(t.body)return!0;const r=(t.method||"").toUpperCase();if(["POST","PUT","PATCH","DELETE"].includes(r))try{t.body=await s.getBody(t)}catch(r){return t.body={},t._prepareError=r,e&&!e.headersSent&&i.json(e,400,{error:"Invalid JSON in request body"}),!1}return!0}static prepareQuery(t){return t.query||(t.query=s.getQuery(t)),!0}static prepareCookies(t){return t.cookies||(t.cookies=s.getCookies(t)),!0}static prepareToken(t,e={cookie:"token",header:"Authorization",query:"token"}){return t.token||(t.token=this.getToken(t,e)),!0}static async getBody(t){if(t.body)return t.body;if(!["POST","PUT","PATCH"].includes(t.method))return;let e="";if(t.on)for await(const r of t)e+=r;else if("object"==typeof t)return t.body||void 0;const r=(t.headers?.["content-type"]||"").toLowerCase();if(r.includes("application/json"))try{return JSON.parse(e)}catch{throw new Error("Invalid JSON in request body")}if(r.includes("application/x-www-form-urlencoded")){const t=new URLSearchParams(e.trim());return Object.fromEntries(t.entries())}return e}static getCookies(t){if(t.cookies)return t.cookies;const e=t?.headers?.cookie;return e?Object.fromEntries(e.split(";").map(t=>t.split("=").map(t=>t.trim())).filter(([t,e])=>t&&e).map(([t,e])=>[t,decodeURIComponent(e)])):{}}static getQuery(t){if(t.query)return t.query;try{const e=new URL(t?.url||"","http://localhost");return Object.fromEntries(e.searchParams.entries())}catch{return{}}}static getToken(t,e={cookie:"token",header:"Authorization",query:"token"}){const r=s.getCookies(t);if(r&&r[e.cookie])return r[e.cookie];const n=t?.headers?.[e.header?.toLowerCase()];if(n){const t=n.split(" ");return 2===t.length&&/^Bearer$/i.test(t[0])?t[1]:n}const o=s.getQuery(t);return o&&o[e.query]?o[e.query]:void 0}static enforceMethod(t,e,r){const n=Array.isArray(t)?t.map(t=>t.toUpperCase()):t.split(/(?:,|\s)+/).map(t=>t.trim().toUpperCase()).filter(Boolean),o=e.method.toUpperCase();return!!n.includes(o)||(r.setHeader("Allow",n.join(", ")),i.json(r,405,{success:!1,error:"Method Not Allowed"}),!1)}}class a{static normalize(t){if("string"!=typeof t||!t.trim())return"/";try{let e=decodeURIComponent(t).replace(/\/{2,}/g,"/");return e.startsWith("/")||(e="/"+e),e.length>1&&e.endsWith("/")&&(e=e.slice(0,-1)),e||"/"}catch{return"/"}}static isBase(t,e){return"/"===t||t===e||e.startsWith(t+"/")}static*subpaths(t){if("/"===(t=t.trim()))return void(yield t);const e=t.startsWith("/")?"/":"",r=t.split("/");let n;for(let t of r)n=n?n+"/"+t:t,yield e+n}static route(t,e,r,n){const o=e.toUpperCase();if(t&&"function"==typeof t[o.toLowerCase()])t[o.toLowerCase()](r,async(t,e,r)=>{try{await n(t,e)}catch(t){r(t)}});else if(t&&"function"==typeof t.route)t.route({method:o,url:r,handler:n});else if(t&&"function"==typeof t.use&&Array.isArray(t.middleware))t.use(async(t,e)=>{if(t.method.toUpperCase()===o&&t.path===r)try{await n(t.req,t.res),t.respond=!1}catch(e){t.status=500,t.body={error:e.message}}else await e()});else{if(!t||"function"!=typeof t.on)throw new Error("Unsupported application framework");t.on("request",async(t,e)=>{const i=new URL(t.url,`http://${t.headers.host}`).pathname;if(t.method.toUpperCase()===o&&i===r)try{await s.prepare(t,e),await n(t,e)}catch(t){e.statusCode=500,e.end(t.message)}})}}static get(t,e,r=!1){let n=t;for(const t of e)void 0===n[t]&&r&&(n[t]={}),n=n[t];return n}static set(t,e,r){a.get(t,e.slice(0,-1),!0)[e[e.length-1]]=r}static keys(t){return t?Array.isArray(t)?t:t.split(".").filter(Boolean):[]}}class c{constructor(t=void 0,e=void 0,r={}){this._parent=t,this._name=e,this._children=r}get parent(){return this._parent}set parent(t){this._parent=t}get name(){return this._name}let(t,e){return this[t]=e,this}letChild(t,e){return this._children[t]=e,e.parent=this,e._name=t,this}get(...t){return this.ancestors().which(e=>t.every(t=>void 0!==e[t])).then(e=>e[t[0]]).what()}getChild(...t){let e=this;for(const r of t)if(e=e?._children?.[r],!e)break;return e}resolve(t){return"string"==typeof t?this.get(t):t}forget(t){return delete this[t],this}isLeaf(){return void 0===this.children().what()}isRoot(){return void 0===this.parent}children(){return l.as(Object.values(this._children))}root(){return this.parent?this.parent.root():this}ancestors(){return l.along(this,t=>t.parent)}}class h extends c{constructor(t=void 0,e=void 0){super(t,void 0),this._last=e,this._length=t?t._length+1:void 0!==e?1:0}static of(...t){return(new h).along(t)}get prev(){return this._parent}get last(){return this._last}get length(){return this._length}let(t,e){throw new Error("A Path is immutable!")}letChild(t,e){throw new Error("A Path is immutable!")}forget(t){throw new Error("A Path is immutable!")}isEmpty(){return 0==this._length}add(t){return new h(0<this.length?this:void 0,t)}along(t){let e=this;for(let r of t)e=e.add(r);return e}across(t){const e=this,r=new l;return r[Symbol.iterator]=function*(){for(let r of t)yield e.add(r)},r}toArray(t=this.length,e=t=>t){const r=new Array(t);let n=this;for(;0<t;)r[t-1]=e(n.last),n=n.prev,t--;return r}}class u{what(...t){throw new Error("Abstract method what() must be implemented in subclasses!")}let(t,e){throw new Error("Abstract method let() must be implemented!")}static of(t,e){return Array.isArray(t)||(t=[t]),u.as((...r)=>l.equal(t,r)?e:void 0)}static as(t){if(t instanceof u)return t;if("function"!=typeof t){const e=t;t=t=>t===e}const e=(...e)=>t(...e);return Object.setPrototypeOf(e,u.prototype),e.what=t,e}if(t=t=>void 0!==t){return u.if(this,t)}static if(t,e=t=>void 0!==t){return u.as(r=>u.what(e,r)?u.what(t,r):void 0)}sthen(t){return u.sthen(this,t)}static sthen(...t){return u.as(e=>{let r=e;for(let e of t){if(void 0===r)break;r=r instanceof Promise?r.stthen(e):u.what(e,r)}return r})}else(t){return u.else(this,t)}static else(...t){return u.as(e=>{let r;for(let n of t){try{r=u.what(n,e)}catch{r=void 0}if(void 0!==r)break}return r})}which(t=t=>void 0!==t){return u.which(this,t)}static which(t,e=t=>void 0!==t){return u.as(r=>l.as(u.what(t,r)).which((t,n)=>e(t,n,r)))}when(t,e=!0,r=e){return u.when(this,t,e,r)}static when(t,e,r=!0,n=r){const o="number"==typeof e;return u.as((...i)=>{const s=o?e:(t,r)=>u.what(e,t,r,...i);return l.as(u.what(t,...i)).when(s,r,n)})}match(...t){return u.match(this,...t)}static match(...t){const e=t.length<2?e=>{const r=u.what(t[0],e);return r[Symbol.iterator]?l.as(r).sthen(t=>[e,t]):[e,r]}:e=>t.map(t=>u.what(t,e));return u.as(e)}each(t){return u.as((...e)=>{const r=new l,n=l.as(this.what(...e)).which();return r[Symbol.iterator]=function*(){for(let e of n)for(let r of l.as(u.what(t,e)).which())yield r},r})}static each(...t){return u.as(e=>{const r=e instanceof h?e:h.of(e);return r.length>t.length?l.of():r.across(l.as(u.what(t[r.length-1],r.last)).which()).which()})}self(t=void 0,e=void 0){return u.self(this,t,e)}static self(t,e=void 0,r=void 0){let n;return n=void 0===e?void 0===r?e=>e.across(l.as(u.what(t,e.last)).which()):(...e)=>{const n=u.what(t,...e);if(void 0===n)return;const o={};return o[r]=n,o}:"number"==typeof e?(...n)=>{const o=n.splice(e,0,r);return u.what(t,...o)}:n=>{const o=l.as("string"==typeof e?[e]:e).sthen(t=>"string"==typeof t?n[t]:t),i=u.what("string"==typeof t?n[t]:t,...o);if(void 0!==i)return void 0!==r?(n[r]=i,n):i},u.as(n)}static what(t,...e){return t instanceof u?t.what(...e):"function"==typeof t?t(...e):t}}class f{[Symbol.asyncIterator](){throw"abstract method!"}static of(...t){const e=new f;return e[Symbol.asyncIterator]=async function*(){for(const e of t)yield await e},e}static as(t){if(t instanceof f)return t;if(null!=t&&"function"==typeof t[Symbol.asyncIterator]){const e=new f;return e[Symbol.asyncIterator]=async function*(){for await(const e of t)yield e},e}if(null!=t&&"function"==typeof t[Symbol.iterator]){const e=new f;return e[Symbol.asyncIterator]=async function*(){for(const e of t)yield e},e}return f.of(t)}async toArray(){const t=[];for await(const e of this)t.push(e);return t}async equals(t){return f.equal(this,t)}static along(t,e){const r=new f;return r[Symbol.asyncIterator]=async function*(){let r=t;for(;null!=r;)yield r,r=await u.what(e,r)},r}static async equal(t,e){const r=f.as(t)[Symbol.asyncIterator](),n=f.as(e)[Symbol.asyncIterator]();for(;;){const[t,e]=await Promise.all([r.next(),n.next()]);if(t.done||e.done)return t.done===e.done;if(t.value instanceof f||e.value instanceof f){if(!await f.equal(t.value,e.value))return!1}else if(t.value!==e.value)return!1}}static isAsyncIterable(t){return null!=t&&"function"==typeof t[Symbol.asyncIterator]}if(t=t=>void 0!==t){const e=this,r=new f;return r[Symbol.asyncIterator]=async function*(){let r=0;for await(const n of e)await t(n,r++)&&(yield n)},r}sthen(t){const e=this,r=new f;return r[Symbol.asyncIterator]=async function*(){let r=0;for await(const n of e)yield await t(n,r++)},r}else(t=void 0){return void 0===t?f.else(this):f.else([this,f.as(t)])}static else(t){const e=new f;return e[Symbol.asyncIterator]=async function*(){for await(const e of f.as(t)){const t=f.as(e);for await(const e of t)yield e}},e}which(t){return this.if(t)}when(t,e=!0,r=e){return f.when(this,t,e,r)}static when(t,e,r=!0,n=r){if(void 0===e){const e={};return e[Symbol.asyncIterator]=async function*(){for await(const e of t)yield e},f.as(e)}if("number"==typeof e){const t=e;e=(e,r)=>r===t}const o=new f;return o[Symbol.asyncIterator]=r?async function*(){let r=0,o=!1;for await(const i of t)o?yield i:await u.what(e,i,r)&&(o=!0,n&&(yield i)),r++}:async function*(){let r=0,o=!1;for await(const i of t){if(o)break;await u.what(e,i,r)?(o=!0,n&&(yield i)):yield i,r++}},o}match(t=void 0){return void 0===t?f.match(this):f.match(this,f.as(t))}static match(...t){const e=new f,r=t.map(t=>f.as(t));return e[Symbol.asyncIterator]=async function*(){const t=r.map(t=>t[Symbol.asyncIterator]());for(;;){const e=await Promise.all(t.map(t=>t.next()));if(e.some(t=>t.done))break;yield e.map(t=>t.value)}},e}each(t=void 0){if(void 0===t)return f.each(...this);const e=this,r=new f;return r[Symbol.asyncIterator]=async function*(){for await(const r of e)for await(const e of f.as(t))yield[r,e]},r}static each(...t){const e=t.map(t=>f.as(t));return u.as(t=>{if(t.length>=e.length)return f.of();const r=e[t.length],n=new f;return n[Symbol.asyncIterator]=async function*(){for await(const e of r)yield t.add(e)},n})}self(){return f.self(this)}static self(t){const e=f.as(t),r=new f;return r[Symbol.asyncIterator]=async function*(){for(;;)yield e},r}what(t,e){return f.what(this,t,e)}static async what(t,e,r){const n=f.as(t);if(e){let t=void 0!==r;for await(const o of n)t?r=await u.what(e,r,o):(r=o,t=!0);return r}for await(const t of n)return t}}class l{[Symbol.iterator](){throw"abstract method!"}static as(t){if(void 0===t)return l.of();if(t instanceof l)return t;if(t[Symbol.iterator]){const e=new l;return e[Symbol.iterator]=t[Symbol.iterator].bind(t),e}{const e=new l;return e[Symbol.iterator]=function*(){yield t},e}}static of(...t){const e=new l;return e[Symbol.iterator]=function*(){for(const e of t)yield e},e}static along(t,e){const r=new l;return r[Symbol.iterator]=function*(){let r=t;for(;r;)yield r,r=u.what(e,r)},r}toArray(){return Array.from(this)}equals(t){return l.equal(this,t)}static equal(t,e){if("string"==typeof t||!l.isIterable(t)||"string"==typeof e||!l.isIterable(e))return t===e;{const r=t[Symbol.iterator](),n=e[Symbol.iterator]();for(;;){const t=r.next(),e=n.next();if(t.done||e.done)return t.done===e.done;if(!l.equal(t.value,e.value))return!1}}}static isIterable(t){return null!=t&&"function"==typeof t[Symbol.iterator]}if(t=t=>void 0!==t){return l.if(this,t)}static if(t,e=t=>void 0!==t){return l.which(t,e)}sthen(t){return l.sthen(this,t)}static sthen(t,e){const r=new l;return r[Symbol.iterator]=function*(){let r=0;for(let n of t)yield u.what(e,n,r++)},r}else(t=void 0){return void 0===t?l.else(this):l.else(l.of(this,l.as(t)))}static else(t){const e=new l;return e[Symbol.iterator]=function*(){for(let e of t)if(e[Symbol.iterator])for(let t of e)yield t;else yield e},e}which(t=t=>void 0!==t){return l.which(this,t)}static which(t,e=t=>void 0!==t){const r=new l;return r[Symbol.iterator]=function*(){let r=0;for(let n of t)u.what(e,n,r++)&&(yield n)},r}when(t,e=!0,r=e){return l.when(this,t,e,r)}static when(t,e,r=!0,n=r){if(void 0===e){const e={};return e[Symbol.asyncIterator]=async function*(){for(const e of t)yield await e},f.as(e)}if("number"==typeof e){const t=e;e=(e,r)=>r===t}const o=new l;return o[Symbol.iterator]=r?function*(){let r=0,o=!1;for(let i of t)o?yield i:u.what(e,i,r)&&(o=!0,n&&(yield i)),r++}:function*(){let r=0,o=!1;for(let i of t){if(o)break;u.what(e,i,r)?(o=!0,n&&(yield i)):yield i,r++}},o}match(t=void 0){return void 0===t?l.match(...this):l.match(this,l.as(t))}static match(...t){const e=new l;return e[Symbol.iterator]=function*(){const e=t.map(t=>t[Symbol.iterator]());for(;;){const t=e.map(t=>t.next());if(t.some(t=>t.done))break;yield t.map(t=>t.value)}},e}each(t=void 0){if(void 0===t)return l.each(...this);const e=this,r=new l;return r[Symbol.iterator]=function*(){for(let r of e)for(let e of l.as(t))yield[r,e]},r}static each(...t){return t=t.map(t=>t[Symbol.iterator]?t:[t]),u.as(e=>e.length<t.length?e.across(t[e.length]):l.of())}self(){return l.self(this)}static self(t){const e=new l;return e[Symbol.iterator]=function*(){for(;;)yield t},e}what(t=void 0,e=void 0){return l.what(this,t,e)}static what(t,e,r){if(e){void 0===r&&(r=l.what(t),t=l.when(t,1));for(let n of t)r=u.what(e,r,n);return r}for(let e of t)return e}}l.NATURAL=new l,l.NATURAL[Symbol.iterator]=function*(){let t=0;for(;;)yield t++};class d extends o.EventEmitter{path;ok;defaultOnError;defaultError;constructor(t,e,r){super(),this.path=h.of(t),this.ok=!0,this.defaultError=e,this.defaultOnError=r}get ctx(){return this.path.last}with(t,e=void 0,r=this.defaultOnError,n=!1){const o=a.get(this.ctx,a.keys(t),n);return o===this.ctx||void 0===o?this.fail(e??{message:`Path not found: ${t}`},void 0,r):(this.path=this.path.add(o),this)}without(t=1){for(let e=0;e<t;e++)this.path.length>1&&(this.path=this.path.parent);return this}check(t=Boolean,e=void 0,r=this.defaultOnError){if(!this.ok)return this;try{if(!t(this.ctx,this))throw e;return this}catch(t){return this.fail(e,t,r)}}async asyncCheck(t=Boolean,e=void 0,r=this.defaultOnError){if(!this.ok)return this;try{if(!await t(this.ctx,this))throw e;return this}catch(t){return this.fail(e,t,r)}}get(t,e=!1){return t?a.get(this.ctx,a.keys(t),e):this.ctx}set(t,e,r=void 0,n=this.defaultOnError,o=!1){if(!this.ok)return this;try{const r=a.keys(t),n=o&&r.length>1?a.get(this.ctx,r.slice(0,-1),!0):this.ctx,i="function"==typeof e?e(n,this):e;r.length>1&&o?n[r[r.length-1]]=i:a.set(this.ctx,r,i)}catch(t){return this.fail(r,t,n)}return this}async asyncSet(t,e,r=void 0,n=this.defaultOnError,o=!1){if(!this.ok)return this;try{const r=a.keys(t),n=o&&r.length>1?a.get(this.ctx,r.slice(0,-1),!0):this.ctx,i="function"==typeof e?await e(n,this):await e;r.length>1&&o?n[r[r.length-1]]=i:a.set(this.ctx,r,i)}catch(t){return this.fail(r,t,n)}return this}async exec(t,e=void 0,r=this.defaultOnError){if(!this.ok)return this;try{t(this.ctx,this)}catch(t){return this.fail(e,t,r)}return this}async asyncExec(t,e=void 0,r=this.defaultOnError){if(!this.ok)return this;try{await t(this.ctx,this)}catch(t){return this.fail(e,t,r)}return this}enrich(t,e){const r=Object.assign({},this.defaultError,t,{emitter:this});return r.message=`${this.defaultError?.message||"handler-fail"}:${t?.message||""}`.replace(/:$/,""),r.cause=e,r}fail(t,e,r=this.defaultOnError){this.ok=!1;const n=this.enrich(t,e);return r&&r(n,this),this.emit(this.defaultError?.message||"handler-fail",n),this.emit(n.message,n),this}}class y{msg;payload;emitter;source;constructor(t,e={},r=void 0,n=void 0){this.msg=t,this.payload=e,this.emitter=r,this.source=n}static fromError(t){const e=t.message||"Unknown error",r={...t};delete r.emitter,t.code&&(r.code=t.code);const n=t.source?y.fromError(t.source):void 0;return new y(e,r,void 0,n)}}class p extends d{constructor(t){super(t,{message:"handler-fail"},p.defaultOnError)}static defaultOnError(t,e){const r=e.get("res");if(!r||r.headersSent)return;const n=y.fromError(t);delete n.emitter;const o=t.code||400;i.json(r,o,n,e)}async prepareBody(t={message:"prepare-body-fail",code:422},e=this.defaultOnError){return this.asyncCheck(async({req:t})=>await s.prepareBody(t),t,e)}prepareQuery(t={message:"prepare-query-fail",code:422},e=this.defaultOnError){return this.check(({req:t})=>(s.prepareQuery(t),!0),t,e)}prepareCookies(t={message:"prepare-cookies-fail",code:422},e=this.defaultOnError){return this.check(({req:t})=>(s.prepareCookies(t),!0),t,e)}prepareToken(t={cookie:"token",header:"Authorization",query:"token"},e={message:"token-prepare-fail",code:401},r=this.defaultOnError){return this.check(({req:e})=>s.prepareToken(e,t),e,r)}checkMethod(...t){return this.check(({req:e})=>t.map(t=>t.toUpperCase()).includes(e.method.toUpperCase()),{message:"method-check",code:405},this.defaultOnError)}checkToken(t=Boolean,e={cookie:"token",header:"Authorization",query:"token"}){return this.check(({req:r})=>(r.token=r.token||s.getToken(r,e),t(r.token)),{message:"token-check",code:401},this.defaultOnError)}checkQueryParam(t,e=Boolean){return this.check(({req:r})=>e(r.query?.[t]),{message:`query-param:${t}-check`,code:422},this.defaultOnError)}checkCookie(t,e=Boolean){return this.check(({req:r})=>e(r.cookies?.[t]),{message:`cookie:${t}-check`,code:422},this.defaultOnError)}checkHeader(t,e=Boolean){return this.check(({req:r})=>e(r.headers?.[t.toLowerCase()]),{message:`header:${t}-check`,code:422},this.defaultOnError)}checkContentType(t){return this.checkHeader("content-type",e=>null!=e&&(t instanceof RegExp?t.test(e):e===t))}checkAccept(t){return this.checkHeader("accept",e=>null!=e&&(t instanceof RegExp?t.test(e):e===t))}}class m extends d{constructor(t,e,r){super(t,e??{message:"dom-handler-fail"},r)}withQuery(t,e=void 0,r=this.defaultOnError){if(!this.ok)return this;const n=this.ctx.querySelector(t);return n?(this.path=this.path.add(n),this):this.fail(e??{message:`Element not found: ${t}`},void 0,r)}setText(t,e,r){return this.exec(e=>{e.textContent="function"==typeof t?t(e,this):t},e,r)}setHTML(t,e,r){return this.asyncExec(e=>{e.innerHTML="function"==typeof t?t(e,this):t},e,r)}setAttr(t,e,r,n){return this.asyncExec(r=>{const n="function"==typeof e?e(r,this):e;r.setAttribute(t,n)},r,n)}async asyncSetText(t,e,r){return this.asyncExec(async e=>{e.textContent="function"==typeof t?await t(e,this):await t},e,r)}async asyncSetHTML(t,e,r){return this.asyncExec(async e=>{e.innerHTML="function"==typeof t?await t(e,this):await t},e,r)}async asyncSetAttr(t,e,r,n){return this.asyncExec(async r=>{const n="function"==typeof e?await e(r,this):await e;r.setAttribute(t,n)},r,n)}}class w{static async within(t,e,r){let n;try{return await Promise.race([e(),new Promise((e,o)=>{n=setTimeout(()=>{const t=new y("timeout-fail",{message:"Operation timed out"},void 0,r);o(t)},t)})])}finally{clearTimeout(n)}}static async resolve(t,e,r,n,o){try{const r="function"==typeof t?t.bind(void 0,e):()=>t;return o?await w.within(o,r,"timeout"):await r()}catch(t){throw r&&(t={...r,source:t}),n&&await n(t),t}}static on(t,e,r,n,o,i){if(i||(i=t),"string"==typeof i&&(i=t[i]||(t[i]={})),o&&i[o]&&this.off(t,e,o,n,i),n?.once&&"function"==typeof t.once)t.once(e,r);else if("function"==typeof t.addEventListener)t.addEventListener(e,r,n);else if("function"==typeof t.addListener)t.addListener(e,r);else{if("function"!=typeof t.on)throw new Error("on-failed",{event:e,fn:r,opts:n,name:o,registry:i},t);t.on(e,r)}o&&(i[o]=r)}static off(t,e,r,n,o){let i=r;if("string"==typeof r){if("string"==typeof o&&(o=t[o]),!o)return;i=o[r],delete o[r]}if(i)if("function"==typeof t.removeEventListener)t.removeEventListener(e,i,n);else if("function"==typeof t.removeListener)t.removeListener(e,i);else{if("function"!=typeof t.off)throw new y("off-failed",{event:e,nameOrFn:r,opts:n,registry:o},t);t.off(e,i)}}static emit(t,e,...r){if("string"!=typeof e&&(r=[e],e=e?.type||"object"),"function"==typeof t.emit)return t.emit(e,...r);if("function"==typeof t.dispatchEvent)return t.dispatchEvent(w.toCustomEvent(r[0]));throw new Error("emit-failed: Target cannot emit events")}static toCustomEvent(t,e="object"){return t instanceof CustomEvent?t:"string"==typeof t?new CustomEvent(t,{detail:{}}):new CustomEvent(t?.type||e,{obj:t})}}return n})());